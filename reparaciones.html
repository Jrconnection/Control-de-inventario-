<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Reparaciones - Sistema</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --panel-soft:#111827;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --primary:#38bdf8;
  --primary-hover:#0ea5e9;
  --green:#22c55e;
  --yellow:#facc15;
  --red:#ef4444;
}

*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background: linear-gradient(135deg,#020617,#0f172a);
  color:var(--text);
  display:flex;
  min-height:100dvh; /* üî• clave para iPhone */
}
main{
  flex:1;
  padding:20px;
  overflow:auto;
  background: transparent;
}

      /* Sidebar */
      aside {
        width: 240px;
        background: #020617;
        border-right: 1px solid var(--border);
        padding: 20px;
      }

      aside h2 {
        font-size: 18px;
        margin-bottom: 30px;
      }

      nav a {
        display: block;
        padding: 12px 14px;
        margin-bottom: 10px;
        border-radius: 10px;
        color: var(--text);
        text-decoration: none;
        background: transparent;
      }

      nav a:hover {
        background: var(--panel);
      }
main{ flex:1; padding:20px; overflow:auto; }
.panel{ background:linear-gradient(180deg,var(--panel),var(--panel-soft)); border:1px solid var(--border); border-radius:14px; padding:20px; margin-bottom:20px; }
input,select,button{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#020617; color:var(--text); }
button{ background:var(--primary); color:#020617; font-weight:600; cursor:pointer; }
button:hover{ background:var(--primary-hover) }
table{ width:100%; border-collapse:collapse; margin-top:12px; }
th,td{ padding:12px; border-bottom:1px solid var(--border); text-align:left; }
.badge{ padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
.pending{ background:rgba(250,204,21,.2); color:var(--yellow); }
.inprogress{ background:rgba(59,130,246,.2); color:#3b82f6; }
.completed{ background:rgba(34,197,94,.15); color:var(--green); }
.details-table th, .details-table td{ padding:8px; font-size:14px; }
.whatsapp-link{ color:var(--primary); text-decoration:none; font-weight:600 }
.whatsapp-link:hover{ text-decoration:underline }
</style>

<style>
/* Responsive tweaks for reparaciones.html */
@media (max-width: 800px) {
  body { flex-direction: column; }
  aside { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
  main { padding: 14px; }
  nav a { display: inline-block; margin-right: 8px; }
  .panel { padding: 12px; }
  input, select, button { width: 100%; margin-top: 8px; }
  .panel { overflow-x: auto; }
  table { min-width: 600px; }
  .details-table th, .details-table td { font-size: 13px; }
}
</style>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, update } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiQ-NtIyWp_CaAj8jjyuDLskzVOoV_H6g",
  authDomain: "control-de-inventario-633f5.firebaseapp.com",
  databaseURL: "https://control-de-inventario-633f5-default-rtdb.firebaseio.com",
  projectId: "control-de-inventario-633f5",
  storageBucket: "control-de-inventario-633f5.firebasestorage.app",
  messagingSenderId: "1012694355492",
  appId: "1:1012694355492:web:08a9ebccbff0c6620ed2b1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let repairs = [];
  let editingId = null;
  // Lista de personal predeterminada ‚Äî ed√≠tala seg√∫n necesites
    const staffList = ['Grethel','Ashly','Fergie','Jamil','Jonathan','Engell','Geovany'];
    // S√≥lo estos son t√©cnicos que pueden ser asignados
    const techList = ['Jonathan','Engell','Geovany'];

  // Llenar selects de personal cuando el DOM est√© listo
  function populateStaffSelects(){
    const selAssigned = document.getElementById('assignedTo');
    const selReceived = document.getElementById('receivedBy');
    if(!selAssigned || !selReceived) return;
    const placeholderA = document.createElement('option'); placeholderA.value=''; placeholderA.textContent='-- Asignado a --'; placeholderA.setAttribute('data-placeholder','1');
    const placeholderR = document.createElement('option'); placeholderR.value=''; placeholderR.textContent='-- Recibi√≥ --'; placeholderR.setAttribute('data-placeholder','1');
    selAssigned.innerHTML = ''; selReceived.innerHTML = '';
    selReceived.appendChild(placeholderR);
    selAssigned.appendChild(placeholderA);
      // Recibi√≥: todos
      staffList.forEach(name=>{
        const o = document.createElement('option'); o.value = name; o.textContent = name;
        selReceived.appendChild(o);
      });
      // Asignado: s√≥lo t√©cnicos
      techList.forEach(name=>{
        const o = document.createElement('option'); o.value = name; o.textContent = name;
        selAssigned.appendChild(o);
      });
  }

  // Abrir WhatsApp con n√∫mero y mensaje predefinido
  window.openWhatsApp = (phone, name)=>{
    const digits = (phone||'').toString().replace(/\D/g,'');
    if(!digits){ alert('N√∫mero inv√°lido'); return; }
    const message = `Hola ${name||''}, te escribo sobre el avance de tu reparaci√≥n.`;
    const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  }

  const searchInput = document.getElementById('search');
  const repairsTable = document.getElementById('repairsTable');
  const completedTable = document.getElementById('completedTable');

  // Escuchar reparaciones
  onValue(ref(db,'repairs'), snapshot=>{
    repairs = [];
    snapshot.forEach(child=>{
      repairs.push({id: child.key, ...child.val()});
    });
    // Normalizar campos antiguos: `responsible` -> `assignedTo`
    repairs = repairs.map(r=>({
      ...r,
      assignedTo: r.assignedTo || r.responsible || '',
      receivedBy: r.receivedBy || ''
    }));
    render();
  });

  // Funci√≥n para agregar reparaci√≥n
  window.addRepair = ()=>{
    const name = document.getElementById('clientName').value.trim();
    const phone = document.getElementById('clientPhone').value.trim();
    const model = document.getElementById('deviceModel').value.trim();
    const color = document.getElementById('deviceColor').value.trim();
    const issue = document.getElementById('issue').value.trim();
    const priceRaw = document.getElementById('price').value.trim();
    const price = priceRaw === '' ? null : parseFloat(priceRaw);
    const assignedTo = document.getElementById('assignedTo').value.trim();
    const receivedBy = document.getElementById('receivedBy').value.trim();

    if(!name || !phone || !model || !issue || !assignedTo || !receivedBy) {
      alert("Todos los campos son obligatorios");
      return;
    }

    if(editingId){
      update(ref(db,'repairs/'+editingId),{
        clientName: name,
        clientPhone: phone,
        model,
        color,
        issue,
        price: price === null ? null : price,
        assignedTo,
        receivedBy
      }).then(()=>{
        editingId = null;
        const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Agregar reparaci√≥n';
        const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = 'none';
        document.getElementById('repairForm').reset();
      });
    } else {
      const newRef = push(ref(db,'repairs'));
      set(newRef,{
        clientName: name,
        clientPhone: phone,
        model,
        color,
        issue,
        price: price === null ? null : price,
        assignedTo,
        receivedBy,
        status: "Pendiente",
        delivered: false,
        receivedAt: new Date().toLocaleString()
      });
      document.getElementById('repairForm').reset();
    }
  }

  // Iniciar edici√≥n: llenar formulario con datos existentes
  window.startEdit = (id)=>{
    const r = repairs.find(x=>x.id===id);
    if(!r) return;
    document.getElementById('clientName').value = r.clientName || '';
    document.getElementById('clientPhone').value = r.clientPhone || '';
    document.getElementById('deviceModel').value = r.model || '';
    document.getElementById('deviceColor').value = r.color || '';
    document.getElementById('issue').value = r.issue || '';
    document.getElementById('price').value = (r.price != null) ? r.price : '';
    // Asegurar que el valor asignado exista en la lista de t√©cnicos; si no, a√±adirlo temporalmente
    const selAssigned = document.getElementById('assignedTo');
    const selReceived = document.getElementById('receivedBy');
    if(r.assignedTo){
      if(!selAssigned.querySelector(`option[value="${r.assignedTo}"]`)){
        const o = document.createElement('option'); o.value = r.assignedTo; o.textContent = r.assignedTo;
        selAssigned.appendChild(o);
      }
      selAssigned.value = r.assignedTo;
    } else {
      selAssigned.value = '';
    }
    selReceived.value = r.receivedBy || '';
    editingId = id;
    const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Guardar cambios';
    const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  window.cancelEdit = ()=>{
    editingId = null;
    document.getElementById('repairForm').reset();
    const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Agregar reparaci√≥n';
    const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = 'none';
  }

  // Cambiar estado de reparaci√≥n
  window.updateStatus = (id,newStatus)=>{
    update(ref(db,'repairs/'+id), {status: newStatus});
  }

  // Marcar como entregado
  window.markDelivered = (id)=>{
    update(ref(db,'repairs/'+id), {delivered:true});
  }

  function render(){
    const s = searchInput.value.toLowerCase();

    // Reparaciones activas (Pendiente o En Proceso)
    repairsTable.innerHTML = repairs
      .filter(r=>!r.delivered && (!s || r.clientName.toLowerCase().includes(s) || r.clientPhone.includes(s)))
      .map(r=>`
        <tr>
          <td>${r.clientName}</td>
          <td><a href="#" class="whatsapp-link" onclick="openWhatsApp('${r.clientPhone}','${r.clientName}')">${r.clientPhone}</a></td>
          <td>${r.model}</td>
          <td>${r.color||'-'}</td>
          <td>${r.issue}</td>
          <td>${r.price==null?'-':r.price}</td>
          <td>${r.receivedBy||'-'}</td>
          <td>${r.assignedTo||'-'}</td>
          <td><span class="badge ${r.status==='Pendiente'?'pending':r.status==='En Proceso'?'inprogress':'completed'}">${r.status}</span></td>
          <td><button onclick="startEdit('${r.id}')">Editar</button></td>
          <td>
            ${r.status!=='Completado'?`<button onclick="updateStatus('${r.id}','En Proceso')">En Proceso</button><button onclick="updateStatus('${r.id}','Completado')">Completar</button>`:''}
            ${!r.delivered?`<button onclick="markDelivered('${r.id}')">Entregar</button>`:''}
          </td>
        </tr>`).join('');

    // Reparaciones completadas
    completedTable.innerHTML = repairs
      .filter(r=>r.delivered)
      .map(r=>`
        <tr>
          <td>${r.clientName}</td>
          <td><a href="#" class="whatsapp-link" onclick="openWhatsApp('${r.clientPhone}','${r.clientName}')">${r.clientPhone}</a></td>
          <td>${r.model}</td>
          <td>${r.color||'-'}</td>
          <td>${r.issue}</td>
          <td>${r.price==null?'-':r.price}</td>
          <td>${r.receivedBy||'-'}</td>
          <td>${r.assignedTo||'-'}</td>
          <td><span class="badge completed">Completado</span></td>
          <td><button onclick="startEdit('${r.id}')">Editar</button></td>
        </tr>`).join('');
  }

  document.addEventListener('DOMContentLoaded', ()=>{ populateStaffSelects(); });
  searchInput.oninput = render;

</script>

</head>
<body>
  <aside>
      <h2>üì± Sistema T√©cnico</h2>
      <nav>
        <a href="index.html">üè† Dashboard</a>
        <a href="inventario.html">üßæ Inventario</a>
        <a href="reparaciones.html">üîß Reparaciones</a>
      </nav>
    </aside>
  <main>
    <h2>Registrar reparaci√≥n</h2>
    <div class="panel">
      <form id="repairForm" onsubmit="event.preventDefault(); addRepair();">
        <input id="clientName" placeholder="Nombre del cliente">
        <input id="clientPhone" placeholder="Tel√©fono del cliente">
        <input id="deviceModel" placeholder="Modelo del dispositivo">
        <input id="deviceColor" placeholder="Color (opcional)">
        <input id="issue" placeholder="Problema / Reparaci√≥n">
        <input id="price" placeholder="Precio">
          <select id="receivedBy"><option data-placeholder value="">-- Recibi√≥ --</option></select>
          <select id="assignedTo"><option data-placeholder value="">-- Asignado a --</option></select>
        <button id="submitRepair" type="submit">Agregar reparaci√≥n</button>
        <button id="cancelEdit" type="button" onclick="cancelEdit()" style="display:none; margin-left:8px; background:transparent; border:1px solid var(--border);">Cancelar</button>
      </form>
    </div>

    <div class="panel">
      <h3>Reparaciones activas</h3>
      <input id="search" placeholder="Buscar cliente o tel√©fono">
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Tel√©fono</th>
            <th>Modelo</th>
            <th>Color</th>
            <th>Problema</th>
            <th>Precio</th>
            <th>Recibi√≥</th>
            <th>Asignado</th>
            <th>Estado</th>
            <th>Editar</th>
            <th>Acciones</th>
              </tr>
        </thead>
        <tbody id="repairsTable"></tbody>
      </table>
    </div>

    <div class="panel">
      <details>
        <summary>üì¶ Ver historial de reparaciones completadas</summary>
        <table class="details-table">
          <thead>
            <tr>
                <th>Cliente</th>
                <th>Tel√©fono</th>
                <th>Modelo</th>
                <th>Color</th>
                <th>Problema</th>
                <th>Precio</th>
                <th>Recibi√≥</th>
                <th>Asignado</th>
                <th>Estado</th>
                <th>Editar</th>
              </tr>
          </thead>
          <tbody id="completedTable"></tbody>
        </table>
      </details>
    </div>

  </main>
</body>
</html>
