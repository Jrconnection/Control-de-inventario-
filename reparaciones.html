<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Reparaciones - Sistema</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --panel-soft:#111827;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --primary:#38bdf8;
  --primary-hover:#0ea5e9;
  --green:#22c55e;
  --yellow:#facc15;
  --red:#ef4444;
  --blue:#60a5fa;
}

*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background: linear-gradient(135deg,#020617,#0f172a);
  color:var(--text);
  display:flex;
  min-height:100dvh;
}
main{
  flex:1;
  padding:20px;
  overflow:auto;
}

/* Sidebar */
aside{
  width: 240px;
  background: #020617;
  border-right: 1px solid var(--border);
  padding: 20px;
}
aside h2{ font-size: 18px; margin:0 0 18px 0; }
nav a{
  display:block;
  padding:12px 14px;
  margin-bottom:10px;
  border-radius:10px;
  color:var(--text);
  text-decoration:none;
}
nav a:hover{ background: var(--panel); }

/* Panels */
.panel{
  background:linear-gradient(180deg,var(--panel),var(--panel-soft));
  border:1px solid var(--border);
  border-radius:14px;
  padding:18px;
  margin-bottom:16px;
}
main h2{ margin:0 0 12px 0; }
.panel h3{ margin:0 0 12px 0; }

/* Inputs */
input,select,button{
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}
input,select{ height:42px; }

button{
  background:var(--primary);
  color:#020617;
  font-weight:800;
  cursor:pointer;
  height:42px;
}
button:hover{ background:var(--primary-hover) }
button:disabled{
  opacity:.55;
  cursor:not-allowed;
}

/* Form grid */
#repairForm{
  display:grid;
  grid-template-columns: repeat(2, minmax(220px, 1fr));
  gap:12px;
  align-items:end;
}
.price-row{
  grid-column:1 / -1;
  display:grid;
  grid-template-columns: 140px 1fr;
  gap:10px;
  align-items:end;
}
.form-actions{
  grid-column:1 / -1;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.form-actions button{
  width:auto;
  padding:0 14px;
}

/* Table wrapper (evita que se salga) */
.table-wrap{
  width:100%;
  overflow-x:auto;
  border-radius:12px;
}

/* Table */
table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  margin-top:12px;
  table-layout: fixed; /* ‚úÖ importante para que no se expanda infinito */
  min-width: 980px;    /* respaldo si la pantalla es peque√±a */
}
thead th{
  position:sticky;
  top:0;
  z-index:2;
  background:#0b1220;
  border-bottom:1px solid var(--border);
}
th,td{
  padding:12px;
  border-bottom:1px solid var(--border);
  text-align:left;
  vertical-align:middle;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* Column sizing (ajusta anchos) */
th.col-phone, td.col-phone{ width: 140px; }
th.col-model, td.col-model{ width: 150px; }
th.col-color, td.col-color{ width: 110px; }
th.col-price, td.col-price{ width: 110px; }
th.col-receivedAt, td.col-receivedAt{ width: 165px; }
th.col-receivedBy, td.col-receivedBy{ width: 120px; }
th.col-assigned, td.col-assigned{ width: 120px; }
th.col-status, td.col-status{ width: 110px; }
th.col-actions, td.col-actions{ width: 320px; } /* ‚úÖ espacio fijo para acciones */

/* allow issue to show a bit more but still clipped */
th.col-issue, td.col-issue{
  white-space:nowrap;
}

/* Badges */
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
}
.pending{ background:rgba(250,204,21,.2); color:var(--yellow); }
.inprogress{ background:rgba(96,165,250,.18); color:var(--blue); }
.completed{ background:rgba(34,197,94,.15); color:var(--green); }
.cancelled{ background:rgba(239,68,68,.20); color:var(--red); }

.details-table th, .details-table td{ padding:10px; font-size:13px; }

/* WhatsApp link */
.whatsapp-link{
  color:var(--primary);
  text-decoration:none;
  font-weight:800;
}
.whatsapp-link:hover{ text-decoration:underline }

/* ‚úÖ Actions: compact chips that wrap (no overflow) */
.actions-cell{
  white-space:normal;          /* ‚úÖ permite salto de l√≠nea */
}
.actions-wrap{
  display:flex;
  flex-wrap:wrap;              /* ‚úÖ se acomodan en 2 filas si hace falta */
  gap:6px;
  align-items:center;
}
.action-btn{
  height:30px !important;
  padding:0 10px !important;
  border-radius:999px !important;
  font-size:12px !important;
  font-weight:900 !important;
  border:1px solid var(--border) !important;
  background: rgba(255,255,255,.06) !important;
  color: var(--text) !important;
}
.action-btn:hover{
  background: rgba(56,189,248,.12) !important;
  border-color: rgba(56,189,248,.25) !important;
}
.action-primary{
  background: rgba(56,189,248,.18) !important;
  border-color: rgba(56,189,248,.22) !important;
}
.action-green{
  background: rgba(34,197,94,.16) !important;
  border-color: rgba(34,197,94,.20) !important;
  color: var(--green) !important;
}
.action-red{
  background: rgba(239,68,68,.16) !important;
  border-color: rgba(239,68,68,.20) !important;
  color: var(--red) !important;
}
.action-yellow{
  background: rgba(250,204,21,.16) !important;
  border-color: rgba(250,204,21,.20) !important;
  color: var(--yellow) !important;
}

/* Mobile actions menu */
.actions-menu{ position:relative; display:none; }
.actions-trigger{
  width:40px;
  height:40px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.06);
  color:var(--text);
  font-size:20px;
  display:grid;
  place-items:center;
  cursor:pointer;
  padding:0;
}
.actions-dropdown{
  position:absolute;
  right:0;
  top:44px;
  min-width:220px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 14px 30px rgba(0,0,0,.35);
  padding:6px;
  display:none;
  z-index:99999;
}
.actions-dropdown button{
  width:100%;
  text-align:left;
  padding:10px 10px;
  border-radius:10px;
  border:1px solid transparent;
  background:transparent;
  color:var(--text);
  display:flex;
  gap:10px;
  align-items:center;
  font-size:14px;
  cursor:pointer;
  height:auto;
}
.actions-dropdown button:hover{
  background:rgba(56,189,248,.12);
  border-color:rgba(56,189,248,.18);
}

/* Modal */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:16px;
}
.modal{
  width:min(760px, 100%);
  background:#0f172a;
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
}
.modal h3{ margin:0 0 8px 0; }
.modal .muted{ color:var(--muted); font-size:13px; margin-bottom:12px; }
.modal-grid{
  display:grid;
  grid-template-columns: 1.2fr .7fr .6fr;
  gap:10px;
  align-items:end;
}
.modal-grid label{
  font-size:13px;
  color:var(--muted);
  display:block;
  margin-bottom:6px;
}
.modal-grid input, .modal-grid select{ width:100%; height:42px; }
.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:14px;
}
.btn-ghost{
  background:transparent !important;
  color:var(--text) !important;
  border:1px solid var(--border) !important;
}
.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  border:1px solid var(--border);
  background:#020617;
  padding:8px 10px;
  border-radius:12px;
}
.pill b{ font-weight:800; }
.pill .x{
  cursor:pointer;
  border:1px solid var(--border);
  border-radius:10px;
  padding:2px 8px;
  background:transparent;
  color:var(--text);
}
.pills-wrap{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }

/* Responsive */
@media (max-width: 900px){
  body{ flex-direction:column; }
  aside{ width:100%; border-right:none; border-bottom:1px solid var(--border); }
  main{ padding:14px; }
  nav a{ display:inline-block; margin-right:8px; margin-bottom:8px; }

  #repairForm{ grid-template-columns:1fr; }
  .price-row{ grid-template-columns:1fr; }

  /* m√≥vil: ocultar chips y usar men√∫ */
  .actions-wrap{ display:none !important; }
  .actions-menu{ display:inline-block !important; }
}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiQ-NtIyWp_CaAj8jjyuDLskzVOoV_H6g",
    authDomain: "control-de-inventario-633f5.firebaseapp.com",
    databaseURL: "https://control-de-inventario-633f5-default-rtdb.firebaseio.com",
    projectId: "control-de-inventario-633f5",
    storageBucket: "control-de-inventario-633f5.firebasestorage.app",
    messagingSenderId: "1012694355492",
    appId: "1:1012694355492:web:08a9ebccbff0c6620ed2b1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let repairs = [];
  let stock = [];
  let editingId = null;

  const staffList = ['Grethel','Ashly','Fergie','Jamil','Jonathan','Engell','Geovany'];
  const techList  = ['Jonathan','Engell','Geovany'];
  const authorizers = ['Jamil','Jonathan'];

  let currentRepair = null;
  let selectedParts = [];

  let searchInput = null;
  let repairsTable = null;
  let completedTable = null;

  // ‚úÖ Pagination
  const PAGE_SIZE = 5;
  let activePage = 1;
  let completedPage = 1;

  let activePager = null;
  let completedPager = null;

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

  function renderPager(container, page, totalPages, onPrev, onNext){
    if(!container) return;

    // Si no hay nada, igual mostramos 1/1 para que quede consistente
    container.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; margin-top:12px; flex-wrap:wrap;">
        <button type="button" class="action-btn" ${page<=1?'disabled':''} id="${container.id}_prev">‚Üê Anterior</button>
        <div style="color:var(--muted); font-weight:800;">
          P√°gina <b style="color:var(--text)">${page}</b> de <b style="color:var(--text)">${totalPages}</b>
        </div>
        <button type="button" class="action-btn" ${page>=totalPages?'disabled':''} id="${container.id}_next">Siguiente ‚Üí</button>
      </div>
    `;

    const prev = document.getElementById(container.id + '_prev');
    const next = document.getElementById(container.id + '_next');
    if(prev) prev.onclick = onPrev;
    if(next) next.onclick = onNext;
  }

  function nowLocalString(){ return new Date().toLocaleString(); }
  function startOfTodayTS(){
    const d = new Date();
    d.setHours(0,0,0,0);
    return d.getTime();
  }

  function askDeliveredBy(){
    const who = prompt('¬øQui√©n entreg√≥ el tel√©fono? (nombre del staff)');
    if(who === null) return null;
    const clean = who.trim();
    if(!clean){
      alert('Debes escribir qui√©n entreg√≥.');
      return null;
    }
    return clean;
  }

  function closeAllActionMenus(exceptMenu){
    document.querySelectorAll('.actions-dropdown').forEach(dd=>{
      const menu = dd.closest('.actions-menu');
      if(exceptMenu && menu === exceptMenu) return;
      dd.style.display = 'none';
    });
  }

  window.toggleActionsMenu = (id)=>{
    const menu = document.getElementById('actionsMenu_' + id);
    if(!menu) return;
    const dd = menu.querySelector('.actions-dropdown');
    if(!dd) return;

    const isOpen = dd.style.display === 'block';
    closeAllActionMenus(menu);
    dd.style.display = isOpen ? 'none' : 'block';
  };

  function populateStaffSelects(){
    const selAssigned = document.getElementById('assignedTo');
    const selReceived = document.getElementById('receivedBy');
    if(!selAssigned || !selReceived) return;

    selAssigned.innerHTML = '';
    selReceived.innerHTML = '';

    const placeholderR = document.createElement('option');
    placeholderR.value = '';
    placeholderR.textContent = '-- Recibi√≥ --';
    selReceived.appendChild(placeholderR);

    const placeholderA = document.createElement('option');
    placeholderA.value = '';
    placeholderA.textContent = '-- Asignado a --';
    selAssigned.appendChild(placeholderA);

    staffList.forEach(name=>{
      const o = document.createElement('option');
      o.value = name; o.textContent = name;
      selReceived.appendChild(o);
    });

    techList.forEach(name=>{
      const o = document.createElement('option');
      o.value = name; o.textContent = name;
      selAssigned.appendChild(o);
    });
  }

  window.openWhatsApp = (phone, name)=>{
    const digits = (phone||'').toString().replace(/\D/g,'');
    if(!digits){ alert('N√∫mero inv√°lido'); return; }
    const message = `Hola ${name||''}, te escribo sobre el avance de tu reparaci√≥n.`;
    const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  };

  /* LISTENERS */
  onValue(ref(db,'stock'), snapshot=>{
    stock = [];
    snapshot.forEach(child=>{
      stock.push({ id: child.key, ...child.val() });
    });

    const modal = document.getElementById('partsModal');
    if(modal && modal.style.display === 'flex'){
      refreshStockSelect();
    }
  });

  onValue(ref(db,'repairs'), snapshot=>{
    repairs = [];
    snapshot.forEach(child=>{
      repairs.push({id: child.key, ...child.val()});
    });

    repairs = repairs.map(r=>({
      ...r,
      assignedTo: r.assignedTo || r.responsible || '',
      receivedBy: r.receivedBy || '',
      partsUsed: Array.isArray(r.partsUsed) ? r.partsUsed : (r.partsUsed ? Object.values(r.partsUsed) : [])
    }));
activePage = 1;

    render();
  });

  /* CRUD */
  window.addRepair = ()=>{
    const name = document.getElementById('clientName').value.trim();
    const phone = document.getElementById('clientPhone').value.trim();
    const model = document.getElementById('deviceModel').value.trim();
    const color = document.getElementById('deviceColor').value.trim();
    const issue = document.getElementById('issue').value.trim();

    const priceRaw = document.getElementById('price').value.trim();
    const currency = document.getElementById('currency').value;
    const price = priceRaw === '' ? null : parseFloat(priceRaw);

    const assignedTo = document.getElementById('assignedTo').value.trim();
    const receivedBy = document.getElementById('receivedBy').value.trim();

    if(!name || !phone || !model || !issue || !assignedTo || !receivedBy) {
      alert("Todos los campos son obligatorios");
      return;
    }

    if(editingId){
      update(ref(db,'repairs/'+editingId),{
        clientName: name,
        clientPhone: phone,
        model, color, issue,
        price: price === null ? null : price,
        currency: currency || 'C$',
        assignedTo, receivedBy
      }).then(()=>{
        editingId = null;
        const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Agregar reparaci√≥n';
        const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = 'none';
        document.getElementById('repairForm').reset();
      });
    } else {
      const newRef = push(ref(db,'repairs'));
      set(newRef,{
        clientName: name,
        clientPhone: phone,
        model, color, issue,
        price: price === null ? null : price,
        currency: currency || 'C$',
        assignedTo, receivedBy,
        status: "Pendiente",
        delivered: false,
        receivedAt: nowLocalString(),
        receivedAtTS: Date.now(),
        partsUsed: []
      });
      document.getElementById('repairForm').reset();

      // ‚úÖ opcional: al agregar, vuelve a p√°gina 1 para ver la m√°s reciente arriba
      activePage = 1;
    }
  };

  window.startEdit = (id)=>{
    const r = repairs.find(x=>x.id===id);
    if(!r) return;

    document.getElementById('clientName').value = r.clientName || '';
    document.getElementById('clientPhone').value = r.clientPhone || '';
    document.getElementById('deviceModel').value = r.model || '';
    document.getElementById('deviceColor').value = r.color || '';
    document.getElementById('issue').value = r.issue || '';

    document.getElementById('price').value = (r.price != null) ? r.price : '';
    const currencySel = document.getElementById('currency');
    if(currencySel) currencySel.value = r.currency || 'C$';

    const selAssigned = document.getElementById('assignedTo');
    const selReceived = document.getElementById('receivedBy');

    if(r.assignedTo){
      if(!selAssigned.querySelector(`option[value="${r.assignedTo}"]`)){
        const o = document.createElement('option'); o.value = r.assignedTo; o.textContent = r.assignedTo;
        selAssigned.appendChild(o);
      }
      selAssigned.value = r.assignedTo;
    } else selAssigned.value = '';

    selReceived.value = r.receivedBy || '';
    editingId = id;

    const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Guardar cambios';
    const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  window.cancelEdit = ()=>{
    editingId = null;
    document.getElementById('repairForm').reset();
    const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Agregar reparaci√≥n';
    const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = 'none';
  };

  window.updateStatus = (id,newStatus)=>{
    const payload = {
      status: newStatus,
      statusUpdatedAt: nowLocalString(),
      statusUpdatedAtTS: Date.now()
    };

    if(newStatus === 'En Proceso'){
      payload.inProgressAt = nowLocalString();
      payload.inProgressAtTS = Date.now();
    }

    if(newStatus === 'Completado'){
      payload.completedAt = nowLocalString();
      payload.completedAtTS = Date.now();
      payload.completedDayTS = startOfTodayTS();
    }

    return update(ref(db,'repairs/'+id), payload);
  };

  window.markDelivered = (id)=>{
    const r = repairs.find(x=>x.id===id);
    const name = r?.clientName || 'este cliente';
    if(!confirm(`¬øConfirmas ENTREGAR el equipo de ${name}?`)) return;

    const deliveredBy = askDeliveredBy();
    if(!deliveredBy) return;

    update(ref(db,'repairs/'+id), {
      delivered:true,
      deliveredAt: nowLocalString(),
      deliveredAtTS: Date.now(),
      deliveredBy
    });
  };

  window.cancelRepair = (id)=>{
    const r = repairs.find(x=>x.id===id);

    const reason = prompt('Motivo de cancelaci√≥n / entrega sin reparar (ej: cliente desisti√≥):');
    if(reason === null) return;
    const clean = reason.trim();
    if(!clean){
      alert('Debes escribir un motivo.');
      return;
    }

    const name = r?.clientName || 'este cliente';
    if(!confirm(`¬øConfirmas ENTREGAR SIN REPARAR el equipo de ${name}?`)) return;

    const deliveredBy = askDeliveredBy();
    if(!deliveredBy) return;

    update(ref(db,'repairs/'+id), {
      status: "Cancelado",
      delivered: true,
      deliveredAt: nowLocalString(),
      deliveredAtTS: Date.now(),
      deliveredBy,
      cancelReason: clean
    });
  };

  /* MODAL REPUESTOS */
  function openPartsModal(repairId){
    const r = repairs.find(x=>x.id===repairId);
    if(!r) return;

    currentRepair = r;
    selectedParts = [];
    renderSelectedParts();

    const stockSearch = document.getElementById('stockSearch');
    if(stockSearch) stockSearch.value = '';

    refreshStockSelect();
    refreshAuthorizerSelect();

    document.getElementById('partsTitle').textContent = `Usar repuestos en: ${r.clientName} (${r.model})`;
    document.getElementById('partsModal').style.display = 'flex';
  }
  window.openPartsModal = openPartsModal;

  function closePartsModal(){
    document.getElementById('partsModal').style.display = 'none';
    currentRepair = null;
    selectedParts = [];
  }
  window.closePartsModal = closePartsModal;

  function refreshStockSelect(){
    const sel = document.getElementById('stockSelect');
    const q = (document.getElementById('stockSearch')?.value || '').toLowerCase().trim();
    if(!sel) return;

    const available = stock
      .filter(i => (i.qty||0) > 0)
      .filter(i => {
        if(!q) return true;
        const text = `${i.model||''} ${i.type||''} ${i.desc||''}`.toLowerCase();
        return text.includes(q);
      })
      .sort((a,b)=> (a.model||'').localeCompare(b.model||''));

    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = available.length ? '-- Seleccionar item del inventario --' : 'Sin resultados';
    sel.appendChild(ph);

    available.forEach(i=>{
      const o = document.createElement('option');
      o.value = i.id;
      o.textContent = `${i.model} ‚Ä¢ ${i.type} ‚Ä¢ ${(i.desc||'-')} (Stock: ${i.qty})`;
      sel.appendChild(o);
    });
  }

  function refreshAuthorizerSelect(){
    const sel = document.getElementById('authSelect');
    if(!sel) return;
    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = '-- Autoriz√≥ --';
    sel.appendChild(ph);
    authorizers.forEach(a=>{
      const o = document.createElement('option');
      o.value = a; o.textContent = a;
      sel.appendChild(o);
    });
  }

  window.addPartLine = ()=>{
    const stockId = document.getElementById('stockSelect').value;
    const qty = parseInt(document.getElementById('partQty').value);

    if(!stockId){ alert('Selecciona un item del inventario'); return; }
    if(!qty || qty <= 0){ alert('Ingresa una cantidad v√°lida'); return; }

    const item = stock.find(x=>x.id===stockId);
    if(!item){ alert('Item no encontrado'); return; }
    if((item.qty||0) < qty){ alert('Stock insuficiente'); return; }

    const existing = selectedParts.find(p=>p.stockId===stockId);
    if(existing){
      if((item.qty||0) < (existing.qty + qty)){
        alert('Stock insuficiente para sumar esa cantidad');
        return;
      }
      existing.qty += qty;
    } else {
      selectedParts.push({
        stockId,
        model: item.model || '',
        type: item.type || '',
        desc: item.desc || '',
        qty
      });
    }

    document.getElementById('stockSelect').value = '';
    document.getElementById('partQty').value = '';
    renderSelectedParts();
  };

  function renderSelectedParts(){
    const wrap = document.getElementById('selectedParts');
    if(!wrap) return;

    if(selectedParts.length === 0){
      wrap.innerHTML = '<div class="muted">A√∫n no has agregado repuestos.</div>';
      return;
    }

    wrap.innerHTML = `
      <div class="pills-wrap">
        ${selectedParts.map((p,idx)=>`
          <div class="pill">
            <div>
              <div><b>${p.model}</b> <span style="color:var(--muted)">‚Ä¢ ${p.type}</span></div>
              <div style="color:var(--muted); font-size:12px">${p.desc||'-'}</div>
            </div>
            <div style="margin-left:auto; font-weight:800">x${p.qty}</div>
            <button class="x" onclick="removeSelectedPart(${idx})">‚úï</button>
          </div>
        `).join('')}
      </div>
      <div class="muted" style="margin-top:8px">Tip: puedes agregar varios items antes de confirmar.</div>
    `;
  }

  window.removeSelectedPart = (idx)=>{
    selectedParts.splice(idx,1);
    renderSelectedParts();
  };

  window.confirmPartsUse = async ()=>{
    if(!currentRepair){ alert('No hay reparaci√≥n seleccionada'); return; }
    if(selectedParts.length === 0){ alert('Agrega al menos un repuesto'); return; }

    const authorizer = document.getElementById('authSelect').value;
    if(!authorizer){ alert('Selecciona qui√©n autoriz√≥'); return; }

    const when = nowLocalString();

    try{
      for(const p of selectedParts){
        const stockRef = ref(db, 'stock/' + p.stockId);
        const result = await runTransaction(stockRef, (current)=>{
          if(current == null) return current;
          const currentQty = current.qty || 0;
          if(currentQty < p.qty) return;
          return { ...current, qty: currentQty - p.qty };
        }, { applyLocally: false });

        if(!result.committed){
          alert(`Stock insuficiente al aplicar: ${p.model}. Intenta de nuevo.`);
          return;
        }
      }

      for(const p of selectedParts){
        await set(push(ref(db,'logs')), {
          date: when,
          model: p.model,
          action: 'Salida',
          qty: p.qty,
          authorizer,
          repairId: currentRepair.id,
          clientName: currentRepair.clientName || ''
        });
      }

      const used = selectedParts.map(p=>({ ...p, date: when, authorizer }));
      const already = Array.isArray(currentRepair.partsUsed) ? currentRepair.partsUsed : [];
      await update(ref(db,'repairs/'+currentRepair.id), {
        partsUsed: [...already, ...used]
      });

      closePartsModal();
      alert('‚úÖ Repuestos aplicados y stock descontado.');
    } catch(err){
      console.error(err);
      alert('‚ùå Error aplicando repuestos. Revisa consola.');
    }
  };

  /* RENDER */
  function render(){
    if(!repairsTable || !completedTable) return;
    const s = (searchInput?.value || '').toLowerCase().trim();

    // ==========================
    // ‚úÖ ACTIVAS (m√°s recientes primero + paginaci√≥n)
    // ==========================
    const activeList = repairs
      .filter(r => !r.delivered)
      .filter(r => {
        if(!s) return true;
        return (r.clientName||'').toLowerCase().includes(s) || (r.clientPhone||'').includes(s);
      })
   .sort((a,b)=>{
  const ta = Number(a.receivedAtTS || 0);
  const tb = Number(b.receivedAtTS || 0);

  // 1) Primero por timestamp (m√°s reciente arriba)
  if(tb !== ta) return tb - ta;

  // 2) Respaldo: por push id (m√°s reciente arriba)
  return String(b.id).localeCompare(String(a.id));
});


    const activeTotalPages = Math.max(1, Math.ceil(activeList.length / PAGE_SIZE));
    activePage = clamp(activePage, 1, activeTotalPages);

    const activeItems = activeList.slice((activePage-1)*PAGE_SIZE, activePage*PAGE_SIZE);

    repairsTable.innerHTML = activeItems.map(r=>{
      const partsCount = (r.partsUsed||[]).reduce((acc,x)=>acc + (x.qty||0), 0);

      const badgeClass =
        r.status==='Pendiente' ? 'pending' :
        r.status==='En Proceso' ? 'inprogress' :
        r.status==='Cancelado' ? 'cancelled' :
        'completed';

      const priceText = (r.price==null) ? '-' : `${r.currency || 'C$'} ${r.price}`;
      const receivedAt = r.receivedAt || '-';

      const actionsHTML = `
        <button class="action-btn action-primary" onclick="startEdit('${r.id}')">‚úé Editar</button>
        ${r.status!=='Completado'
          ? `<button class="action-btn action-yellow" onclick="updateStatus('${r.id}','En Proceso')">‚ñ∂Ô∏è Proceso</button>
             <button class="action-btn action-green" onclick="updateStatus('${r.id}','Completado')">‚úì Completar</button>`
          : ''
        }
        <button class="action-btn" onclick="openPartsModal('${r.id}')">üß© Repuestos ${partsCount?`(${partsCount})`:''}</button>
        ${!r.delivered ? `<button class="action-btn" onclick="markDelivered('${r.id}')">üì¶ Entregar</button>` : ''}
        ${!r.delivered ? `<button class="action-btn action-red" onclick="cancelRepair('${r.id}')">‚úï Sin reparar</button>` : ''}
      `;

      return `
      <tr>
        <td>${r.clientName}</td>
        <td class="col-phone"><a href="#" class="whatsapp-link" onclick="openWhatsApp('${r.clientPhone}','${r.clientName}')">${r.clientPhone}</a></td>
        <td class="col-model">${r.model}</td>
        <td class="col-color">${r.color||'-'}</td>
        <td class="col-issue" title="${(r.issue||'').replace(/"/g,'&quot;')}">${r.issue}</td>
        <td class="col-price">${priceText}</td>
        <td class="col-receivedAt">${receivedAt}</td>
        <td class="col-receivedBy">${r.receivedBy||'-'}</td>
        <td class="col-assigned">${r.assignedTo||'-'}</td>
        <td class="col-status"><span class="badge ${badgeClass}">${r.status}</span></td>

        <td class="col-actions actions-cell">
          <div class="actions-wrap">${actionsHTML}</div>

          <div class="actions-menu" id="actionsMenu_${r.id}">
            <button type="button" class="actions-trigger" onclick="toggleActionsMenu('${r.id}')">‚ãØ</button>
            <div class="actions-dropdown">
              ${actionsHTML}
            </div>
          </div>
        </td>
      </tr>`;
    }).join('');

    renderPager(
      activePager,
      activePage,
      activeTotalPages,
      ()=>{ activePage = clamp(activePage-1, 1, activeTotalPages); render(); },
      ()=>{ activePage = clamp(activePage+1, 1, activeTotalPages); render(); }
    );

    // ==========================
    // ‚úÖ HISTORIAL (m√°s recientes primero + paginaci√≥n)
    // ==========================
    const completedList = repairs
      .filter(r => r.delivered || r.status === 'Completado' || r.status === 'Cancelado')
      .sort((a,b)=>{
        const ta = a.deliveredAtTS || a.completedAtTS || a.receivedAtTS || 0;
        const tb = b.deliveredAtTS || b.completedAtTS || b.receivedAtTS || 0;
        return tb - ta;
      });

    const completedTotalPages = Math.max(1, Math.ceil(completedList.length / PAGE_SIZE));
    completedPage = clamp(completedPage, 1, completedTotalPages);

    const completedItems = completedList.slice((completedPage-1)*PAGE_SIZE, completedPage*PAGE_SIZE);

    completedTable.innerHTML = completedItems.map(r=>{
      const partsCount = (r.partsUsed||[]).reduce((acc,x)=>acc + (x.qty||0), 0);

      const isCancelled = (r.status === 'Cancelado');
      const badge = isCancelled
        ? `<span class="badge cancelled">Cancelado</span>`
        : `<span class="badge completed">Completado</span>`;

      const priceText = (r.price==null) ? '-' : `${r.currency || 'C$'} ${r.price}`;
      const receivedAt = r.receivedAt || '-';
      const deliveredBy = r.deliveredBy || '-';

      return `
      <tr>
        <td>${r.clientName}</td>
        <td class="col-phone"><a href="#" class="whatsapp-link" onclick="openWhatsApp('${r.clientPhone}','${r.clientName}')">${r.clientPhone}</a></td>
        <td class="col-model">${r.model}</td>
        <td class="col-color">${r.color||'-'}</td>
        <td class="col-issue" title="${(r.issue||'').replace(/"/g,'&quot;')}">${r.issue}</td>
        <td class="col-price">${priceText}</td>
        <td class="col-receivedAt">${receivedAt}</td>
        <td class="col-receivedBy">${r.receivedBy||'-'}</td>
        <td class="col-assigned">${r.assignedTo||'-'}</td>
        <td class="col-status">${badge}</td>
        <td class="col-actions actions-cell">
          <div class="actions-wrap">
            <button class="action-btn action-primary" onclick="startEdit('${r.id}')">‚úé Editar</button>
            <button class="action-btn" onclick="openPartsModal('${r.id}')">üß© Repuestos ${partsCount?`(${partsCount})`:''}</button>
            <span class="action-btn" style="cursor:default; opacity:.85;">Entreg√≥: ${deliveredBy}</span>
          </div>
        </td>
      </tr>`;
    }).join('');

    renderPager(
      completedPager,
      completedPage,
      completedTotalPages,
      ()=>{ completedPage = clamp(completedPage-1, 1, completedTotalPages); render(); },
      ()=>{ completedPage = clamp(completedPage+1, 1, completedTotalPages); render(); }
    );
  }

  /* DOM READY */
  document.addEventListener('DOMContentLoaded', ()=>{
    searchInput = document.getElementById('search');
    repairsTable = document.getElementById('repairsTable');
    completedTable = document.getElementById('completedTable');

    // ‚úÖ pager containers
    activePager = document.getElementById('activePager');
    completedPager = document.getElementById('completedPager');

    populateStaffSelects();

    // ‚úÖ al buscar, vuelve a p√°gina 1 de activas
    if(searchInput) searchInput.oninput = ()=>{
      activePage = 1;
      render();
    };

    const stockSearch = document.getElementById('stockSearch');
    if(stockSearch) stockSearch.addEventListener('input', refreshStockSelect);

    const overlay = document.getElementById('partsModal');
    overlay?.addEventListener('click', (e)=>{
      if(e.target === overlay) closePartsModal();
    });

    document.addEventListener('click', (e)=>{
      if(e.target.closest('.actions-trigger')) return;
      if(e.target.closest('.actions-dropdown')) return;
      closeAllActionMenus();
    }, true);

    window.addEventListener('scroll', ()=> closeAllActionMenus(), { passive:true });
    window.addEventListener('resize', ()=> closeAllActionMenus(), { passive:true });

    render();
  });
</script>

</head>
<body>
  <aside>
    <h2>üì± Sistema T√©cnico</h2>
    <nav>
      <a href="index.html">üè† Dashboard</a>
      <a href="inventario.html">üßæ Inventario</a>
      <a href="reparaciones.html" style="background:#0f172a">üîß Reparaciones</a>
      <a href="proceso.html">‚ö° Proceso (TV)</a>
    </nav>
  </aside>

  <main>
    <h2>Registrar reparaci√≥n</h2>

    <div class="panel">
      <form id="repairForm" onsubmit="event.preventDefault(); addRepair();">
        <input id="clientName" placeholder="Nombre del cliente">
        <input id="clientPhone" placeholder="Tel√©fono del cliente">
        <input id="deviceModel" placeholder="Modelo del dispositivo">
        <input id="deviceColor" placeholder="Color (opcional)">
        <input id="issue" placeholder="Problema / Reparaci√≥n">

        <div class="price-row">
          <select id="currency">
            <option value="C$">C$</option>
            <option value="$">$</option>
          </select>
          <input id="price" placeholder="Precio">
        </div>

        <select id="receivedBy"><option value="">-- Recibi√≥ --</option></select>
        <select id="assignedTo"><option value="">-- Asignado a --</option></select>

        <div class="form-actions">
          <button id="submitRepair" type="submit">Agregar reparaci√≥n</button>
          <button id="cancelEdit" type="button" onclick="cancelEdit()" style="display:none; background:transparent; border:1px solid var(--border); color:var(--text);">Cancelar</button>
        </div>
      </form>
    </div>

    <div class="panel">
      <h3>Reparaciones activas</h3>
      <input id="search" placeholder="Buscar cliente o tel√©fono">

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Cliente</th>
              <th class="col-phone">Tel√©fono</th>
              <th class="col-model">Modelo</th>
              <th class="col-color">Color</th>
              <th class="col-issue">Problema</th>
              <th class="col-price">Precio</th>
              <th class="col-receivedAt">Recibido</th>
              <th class="col-receivedBy">Recibi√≥</th>
              <th class="col-assigned">Asignado</th>
              <th class="col-status">Estado</th>
              <th class="col-actions">Acciones</th>
            </tr>
          </thead>
          <tbody id="repairsTable"></tbody>
        </table>
      </div>

      <!-- ‚úÖ Pager Activas -->
      <div id="activePager"></div>
    </div>

    <div class="panel">
      <details>
        <summary>üì¶ Ver historial de reparaciones completadas</summary>

        <div class="table-wrap">
          <table class="details-table">
            <thead>
              <tr>
                <th>Cliente</th>
                <th class="col-phone">Tel√©fono</th>
                <th class="col-model">Modelo</th>
                <th class="col-color">Color</th>
                <th class="col-issue">Problema</th>
                <th class="col-price">Precio</th>
                <th class="col-receivedAt">Recibido</th>
                <th class="col-receivedBy">Recibi√≥</th>
                <th class="col-assigned">Asignado</th>
                <th class="col-status">Estado</th>
                <th class="col-actions">Acciones</th>
              </tr>
            </thead>
            <tbody id="completedTable"></tbody>
          </table>
        </div>

        <!-- ‚úÖ Pager Historial -->
        <div id="completedPager"></div>
      </details>
    </div>
  </main>

  <!-- Modal Repuestos -->
  <div class="modal-overlay" id="partsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="partsTitle">Usar repuestos</h3>
      <div class="muted">
        Busca por modelo/tipo/desc, agrega items con cantidad y confirma.
        Se registrar√° como salida y se guardar√° en la reparaci√≥n.
      </div>

      <div class="modal-grid">
        <div>
          <label>Buscar repuesto</label>
          <input id="stockSearch" placeholder="Ej: iPhone 11, bater√≠a, OLED...">
        </div>

        <div style="grid-column: 2 / span 2;">
          <label>Item del inventario</label>
          <select id="stockSelect"></select>
        </div>

        <div>
          <label>Cantidad</label>
          <input id="partQty" type="number" min="1" placeholder="Ej: 1">
        </div>

        <div>
          <button type="button" onclick="addPartLine()">Agregar</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label style="font-size:13px; color:var(--muted); display:block; margin-bottom:6px">Autoriz√≥</label>
        <select id="authSelect"></select>
      </div>

      <div id="selectedParts" style="margin-top:10px"></div>

      <div class="modal-actions">
        <button class="btn-ghost" type="button" onclick="closePartsModal()">Cancelar</button>
        <button type="button" onclick="confirmPartsUse()">Confirmar salida</button>
      </div>
    </div>
  </div>

</body>
</html>
