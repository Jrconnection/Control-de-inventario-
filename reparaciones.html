<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Reparaciones - Sistema</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --panel-soft:#111827;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --primary:#38bdf8;
  --primary-hover:#0ea5e9;
  --green:#22c55e;
  --yellow:#facc15;
  --red:#ef4444;
}

*{ box-sizing:border-box }
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background: linear-gradient(135deg,#020617,#0f172a);
  color:var(--text);
  display:flex;
  min-height:100dvh;
}
main{
  flex:1;
  padding:20px;
  overflow:auto;
  background: transparent;
}

/* Sidebar */
aside {
  width: 240px;
  background: #020617;
  border-right: 1px solid var(--border);
  padding: 20px;
}
aside h2 { font-size: 18px; margin-bottom: 30px; }
nav a {
  display: block;
  padding: 12px 14px;
  margin-bottom: 10px;
  border-radius: 10px;
  color: var(--text);
  text-decoration: none;
  background: transparent;
}
nav a:hover { background: var(--panel); }

.panel{
  background:linear-gradient(180deg,var(--panel),var(--panel-soft));
  border:1px solid var(--border);
  border-radius:14px;
  padding:20px;
  margin-bottom:20px;
}
input,select,button{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}
button{
  background:var(--primary);
  color:#020617;
  font-weight:600;
  cursor:pointer;
}
button:hover{ background:var(--primary-hover) }
table{ width:100%; border-collapse:collapse; margin-top:12px; }
th,td{ padding:12px; border-bottom:1px solid var(--border); text-align:left; }
.badge{ padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
.pending{ background:rgba(250,204,21,.2); color:var(--yellow); }
.inprogress{ background:rgba(59,130,246,.2); color:#3b82f6; }
.completed{ background:rgba(34,197,94,.15); color:var(--green); }

/* ‚úÖ NUEVO: badge para cancelada */
.cancelled{ background:rgba(239,68,68,.20); color:var(--red); }

.details-table th, .details-table td{ padding:8px; font-size:14px; }
.whatsapp-link{ color:var(--primary); text-decoration:none; font-weight:600 }
.whatsapp-link:hover{ text-decoration:underline }

/* Modal (repuestos) */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
  padding:16px;
}
.modal{
  width:min(760px, 100%);
  background:#0f172a;
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
}
.modal h3{ margin:0 0 8px 0; }
.modal .muted{ color:var(--muted); font-size:13px; margin-bottom:12px; }
.modal-grid{
  display:grid;
  grid-template-columns: 1.2fr .7fr .6fr;
  gap:10px;
  align-items:end;
}
.modal-grid label{ font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
.modal-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:14px;
}
.btn-ghost{
  background:transparent !important;
  color:var(--text) !important;
  border:1px solid var(--border) !important;
}
.small{
  font-size:12px;
  padding:6px 8px;
  border-radius:10px;
}
.pill{
  display:inline-flex;
  gap:8px;
  align-items:center;
  border:1px solid var(--border);
  background:#020617;
  padding:8px 10px;
  border-radius:12px;
}
.pill b{ font-weight:700; }
.pill .x{
  cursor:pointer;
  border:1px solid var(--border);
  border-radius:10px;
  padding:2px 8px;
  background:transparent;
  color:var(--text);
}
.pills-wrap{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }

/* ============================
   ‚úÖ NUEVO: MEN√ö ACCIONES (‚ãØ)
   ============================ */
.actions-cell{ white-space:nowrap; }

.actions-wrap{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

/* men√∫ m√≥vil */
.actions-menu{
  position:relative;
  display:none; /* se activa en m√≥vil por media query */
}

.actions-trigger{
  width:36px;
  height:36px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.05);
  color:var(--text);
  font-size:20px;
  display:grid;
  place-items:center;
  cursor:pointer;
  padding:0;
}

.actions-dropdown{
  position:absolute;
  right:0;
  top:44px;
  min-width:200px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 14px 30px rgba(0,0,0,.35);
  padding:6px;
  display:none;
  z-index:99999;
}

.actions-dropdown button{
  width:100%;
  text-align:left;
  padding:10px 10px;
  border-radius:10px;
  border:1px solid transparent;
  background:transparent;
  color:var(--text);
  display:flex;
  gap:10px;
  align-items:center;
  font-size:14px;
  cursor:pointer;
}

.actions-dropdown button:hover{
  background:rgba(56,189,248,.12);
  border-color:rgba(56,189,248,.18);
}

/* Responsive */
@media (max-width: 800px) {
  body { flex-direction: column; }
  aside { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
  main { padding: 14px; }
  nav a { display: inline-block; margin-right: 8px; }
  .panel { padding: 12px; }
  input, select, button { width: 100%; margin-top: 8px; }
  .panel { overflow-x: auto; }
  table { min-width: 600px; }
  .details-table th, .details-table td { font-size: 13px; }
  .modal-grid{ grid-template-columns: 1fr; }

  /* ‚úÖ En m√≥vil: ocultar botones y usar men√∫ */
  .actions-wrap{ display:none !important; }
  .actions-menu{ display:inline-block !important; }
  .actions-trigger{ width:40px; height:40px; } /* un poquito m√°s f√°cil de tocar */
}
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, update, runTransaction } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAiQ-NtIyWp_CaAj8jjyuDLskzVOoV_H6g",
    authDomain: "control-de-inventario-633f5.firebaseapp.com",
    databaseURL: "https://control-de-inventario-633f5-default-rtdb.firebaseio.com",
    projectId: "control-de-inventario-633f5",
    storageBucket: "control-de-inventario-633f5.firebasestorage.app",
    messagingSenderId: "1012694355492",
    appId: "1:1012694355492:web:08a9ebccbff0c6620ed2b1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let repairs = [];
  let stock = [];
  let editingId = null;

  const staffList = ['Grethel','Ashly','Fergie','Jamil','Jonathan','Engell','Geovany'];
  const techList  = ['Jonathan','Engell','Geovany'];
  const authorizers = ['Jamil','Jonathan'];

  // Modal state
  let currentRepair = null;
  let selectedParts = [];

  // DOM refs (se asignan al cargar DOM)
  let searchInput = null;
  let repairsTable = null;
  let completedTable = null;

  /* ============================
     ‚úÖ NUEVO: acciones menu JS
     ============================ */
  function closeAllActionMenus(exceptMenu){
    document.querySelectorAll('.actions-dropdown').forEach(dd=>{
      const menu = dd.closest('.actions-menu');
      if(exceptMenu && menu === exceptMenu) return;
      dd.style.display = 'none';
    });
  }

  window.toggleActionsMenu = (id)=>{
    const menu = document.getElementById('actionsMenu_' + id);
    if(!menu) return;
    const dd = menu.querySelector('.actions-dropdown');
    if(!dd) return;

    const isOpen = dd.style.display === 'block';
    closeAllActionMenus(menu);
    dd.style.display = isOpen ? 'none' : 'block';
  };
  /* ============================ */

  function populateStaffSelects(){
    const selAssigned = document.getElementById('assignedTo');
    const selReceived = document.getElementById('receivedBy');
    if(!selAssigned || !selReceived) return;

    selAssigned.innerHTML = '';
    selReceived.innerHTML = '';

    const placeholderR = document.createElement('option');
    placeholderR.value = '';
    placeholderR.textContent = '-- Recibi√≥ --';
    selReceived.appendChild(placeholderR);

    const placeholderA = document.createElement('option');
    placeholderA.value = '';
    placeholderA.textContent = '-- Asignado a --';
    selAssigned.appendChild(placeholderA);

    staffList.forEach(name=>{
      const o = document.createElement('option'); o.value = name; o.textContent = name;
      selReceived.appendChild(o);
    });

    techList.forEach(name=>{
      const o = document.createElement('option'); o.value = name; o.textContent = name;
      selAssigned.appendChild(o);
    });
  }

  window.openWhatsApp = (phone, name)=>{
    const digits = (phone||'').toString().replace(/\D/g,'');
    if(!digits){ alert('N√∫mero inv√°lido'); return; }
    const message = `Hola ${name||''}, te escribo sobre el avance de tu reparaci√≥n.`;
    const url = `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  };

  // --------------------
  // LISTENERS FIREBASE
  // --------------------
  onValue(ref(db,'stock'), snapshot=>{
    stock = [];
    snapshot.forEach(child=>{
      stock.push({ id: child.key, ...child.val() });
    });

    // si el modal est√° abierto, refrescar lista filtrada
    const modal = document.getElementById('partsModal');
    if(modal && modal.style.display === 'flex'){
      refreshStockSelect();
    }
  });

  onValue(ref(db,'repairs'), snapshot=>{
    repairs = [];
    snapshot.forEach(child=>{
      repairs.push({id: child.key, ...child.val()});
    });

    repairs = repairs.map(r=>({
      ...r,
      assignedTo: r.assignedTo || r.responsible || '',
      receivedBy: r.receivedBy || '',
      partsUsed: Array.isArray(r.partsUsed) ? r.partsUsed : (r.partsUsed ? Object.values(r.partsUsed) : [])
    }));

    render(); // ahora render es seguro si DOM no est√° listo
  });

  // --------------------
  // CRUD REPARACIONES
  // --------------------
  window.addRepair = ()=>{
    const name = document.getElementById('clientName').value.trim();
    const phone = document.getElementById('clientPhone').value.trim();
    const model = document.getElementById('deviceModel').value.trim();
    const color = document.getElementById('deviceColor').value.trim();
    const issue = document.getElementById('issue').value.trim();
    const priceRaw = document.getElementById('price').value.trim();
    const price = priceRaw === '' ? null : parseFloat(priceRaw);
    const assignedTo = document.getElementById('assignedTo').value.trim();
    const receivedBy = document.getElementById('receivedBy').value.trim();

    if(!name || !phone || !model || !issue || !assignedTo || !receivedBy) {
      alert("Todos los campos son obligatorios");
      return;
    }

    if(editingId){
      update(ref(db,'repairs/'+editingId),{
        clientName: name,
        clientPhone: phone,
        model, color, issue,
        price: price === null ? null : price,
        assignedTo, receivedBy
      }).then(()=>{
        editingId = null;
        const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Agregar reparaci√≥n';
        const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = 'none';
        document.getElementById('repairForm').reset();
      });
    } else {
      const newRef = push(ref(db,'repairs'));
      set(newRef,{
        clientName: name,
        clientPhone: phone,
        model, color, issue,
        price: price === null ? null : price,
        assignedTo, receivedBy,
        status: "Pendiente",
        delivered: false,
        receivedAt: new Date().toLocaleString(),
        partsUsed: []
      });
      document.getElementById('repairForm').reset();
    }
  };

  window.startEdit = (id)=>{
    const r = repairs.find(x=>x.id===id);
    if(!r) return;

    document.getElementById('clientName').value = r.clientName || '';
    document.getElementById('clientPhone').value = r.clientPhone || '';
    document.getElementById('deviceModel').value = r.model || '';
    document.getElementById('deviceColor').value = r.color || '';
    document.getElementById('issue').value = r.issue || '';
    document.getElementById('price').value = (r.price != null) ? r.price : '';

    const selAssigned = document.getElementById('assignedTo');
    const selReceived = document.getElementById('receivedBy');

    if(r.assignedTo){
      if(!selAssigned.querySelector(`option[value="${r.assignedTo}"]`)){
        const o = document.createElement('option'); o.value = r.assignedTo; o.textContent = r.assignedTo;
        selAssigned.appendChild(o);
      }
      selAssigned.value = r.assignedTo;
    } else selAssigned.value = '';

    selReceived.value = r.receivedBy || '';
    editingId = id;

    const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Guardar cambios';
    const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  window.cancelEdit = ()=>{
    editingId = null;
    document.getElementById('repairForm').reset();
    const submit = document.getElementById('submitRepair'); if(submit) submit.textContent = 'Agregar reparaci√≥n';
    const cancel = document.getElementById('cancelEdit'); if(cancel) cancel.style.display = 'none';
  };

  window.updateStatus = (id,newStatus)=> update(ref(db,'repairs/'+id), {status: newStatus});
  window.markDelivered = (id)=> update(ref(db,'repairs/'+id), {delivered:true});

  // ‚úÖ NUEVO: cancelar / entregar sin reparar (sin borrar)
  window.cancelRepair = (id)=>{
    const r = repairs.find(x=>x.id===id);

    // Motivo obligatorio
    const reason = prompt('Motivo de cancelaci√≥n / entrega sin reparar (ej: cliente desisti√≥):');
    if(reason === null) return;
    const clean = reason.trim();
    if(!clean){
      alert('Debes escribir un motivo.');
      return;
    }

    const name = r?.clientName || 'este cliente';
    if(!confirm(`¬øConfirmas ENTREGAR SIN REPARAR el equipo de ${name}?`)) return;

    update(ref(db,'repairs/'+id), {
      status: "Cancelado",
      delivered: true,
      deliveredAt: new Date().toLocaleString(),
      cancelReason: clean
    });
  };

  // ---------------------------
  // MODAL: USAR REPUESTOS
  // ---------------------------
  function openPartsModal(repairId){
    const r = repairs.find(x=>x.id===repairId);
    if(!r) return;

    currentRepair = r;
    selectedParts = [];
    renderSelectedParts();

    const stockSearch = document.getElementById('stockSearch');
    if(stockSearch) stockSearch.value = '';

    refreshStockSelect();
    refreshAuthorizerSelect();

    document.getElementById('partsTitle').textContent = `Usar repuestos en: ${r.clientName} (${r.model})`;
    document.getElementById('partsModal').style.display = 'flex';
  }
  window.openPartsModal = openPartsModal;

  function closePartsModal(){
    document.getElementById('partsModal').style.display = 'none';
    currentRepair = null;
    selectedParts = [];
  }
  window.closePartsModal = closePartsModal;

  function refreshStockSelect(){
    const sel = document.getElementById('stockSelect');
    const q = (document.getElementById('stockSearch')?.value || '').toLowerCase().trim();
    if(!sel) return;

    const available = stock
      .filter(i => (i.qty||0) > 0)
      .filter(i => {
        if(!q) return true;
        const text = `${i.model||''} ${i.type||''} ${i.desc||''}`.toLowerCase();
        return text.includes(q);
      })
      .sort((a,b)=> (a.model||'').localeCompare(b.model||''));

    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = available.length ? '-- Seleccionar item del inventario --' : 'Sin resultados';
    sel.appendChild(ph);

    available.forEach(i=>{
      const o = document.createElement('option');
      o.value = i.id;
      o.textContent = `${i.model} ‚Ä¢ ${i.type} ‚Ä¢ ${(i.desc||'-')} (Stock: ${i.qty})`;
      sel.appendChild(o);
    });
  }

  function refreshAuthorizerSelect(){
    const sel = document.getElementById('authSelect');
    if(!sel) return;
    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value = '';
    ph.textContent = '-- Autoriz√≥ --';
    sel.appendChild(ph);
    authorizers.forEach(a=>{
      const o = document.createElement('option');
      o.value = a; o.textContent = a;
      sel.appendChild(o);
    });
  }

  window.addPartLine = ()=>{
    const stockId = document.getElementById('stockSelect').value;
    const qty = parseInt(document.getElementById('partQty').value);

    if(!stockId){ alert('Selecciona un item del inventario'); return; }
    if(!qty || qty <= 0){ alert('Ingresa una cantidad v√°lida'); return; }

    const item = stock.find(x=>x.id===stockId);
    if(!item){ alert('Item no encontrado'); return; }
    if((item.qty||0) < qty){ alert('Stock insuficiente'); return; }

    const existing = selectedParts.find(p=>p.stockId===stockId);
    if(existing){
      if((item.qty||0) < (existing.qty + qty)){
        alert('Stock insuficiente para sumar esa cantidad');
        return;
      }
      existing.qty += qty;
    } else {
      selectedParts.push({
        stockId,
        model: item.model || '',
        type: item.type || '',
        desc: item.desc || '',
        qty
      });
    }

    document.getElementById('stockSelect').value = '';
    document.getElementById('partQty').value = '';
    renderSelectedParts();
  };

  function renderSelectedParts(){
    const wrap = document.getElementById('selectedParts');
    if(!wrap) return;

    if(selectedParts.length === 0){
      wrap.innerHTML = '<div class="muted">A√∫n no has agregado repuestos.</div>';
      return;
    }

    wrap.innerHTML = `
      <div class="pills-wrap">
        ${selectedParts.map((p,idx)=>`
          <div class="pill">
            <div>
              <div><b>${p.model}</b> <span style="color:var(--muted)">‚Ä¢ ${p.type}</span></div>
              <div style="color:var(--muted); font-size:12px">${p.desc||'-'}</div>
            </div>
            <div style="margin-left:auto; font-weight:700">x${p.qty}</div>
            <button class="x" onclick="removeSelectedPart(${idx})">‚úï</button>
          </div>
        `).join('')}
      </div>
      <div class="muted" style="margin-top:8px">Tip: puedes agregar varios items antes de confirmar.</div>
    `;
  }

  window.removeSelectedPart = (idx)=>{
    selectedParts.splice(idx,1);
    renderSelectedParts();
  };

  window.confirmPartsUse = async ()=>{
    if(!currentRepair){ alert('No hay reparaci√≥n seleccionada'); return; }
    if(selectedParts.length === 0){ alert('Agrega al menos un repuesto'); return; }

    const authorizer = document.getElementById('authSelect').value;
    if(!authorizer){ alert('Selecciona qui√©n autoriz√≥'); return; }

    const when = new Date().toLocaleString();

    try{
      // 1) descontar stock con transacciones
      for(const p of selectedParts){
        const stockRef = ref(db, 'stock/' + p.stockId);
        const result = await runTransaction(stockRef, (current)=>{
          if(current == null) return current;
          const currentQty = current.qty || 0;
          if(currentQty < p.qty) return; // aborta
          return { ...current, qty: currentQty - p.qty };
        }, { applyLocally: false });

        if(!result.committed){
          alert(`Stock insuficiente al aplicar: ${p.model}. Intenta de nuevo.`);
          return;
        }
      }

      // 2) registrar logs (salida)
      for(const p of selectedParts){
        await set(push(ref(db,'logs')), {
          date: when,
          model: p.model,
          action: 'Salida',
          qty: p.qty,
          authorizer,
          repairId: currentRepair.id,
          clientName: currentRepair.clientName || ''
        });
      }

      // 3) guardar en reparaci√≥n
      const used = selectedParts.map(p=>({ ...p, date: when, authorizer }));
      const already = Array.isArray(currentRepair.partsUsed) ? currentRepair.partsUsed : [];
      await update(ref(db,'repairs/'+currentRepair.id), {
        partsUsed: [...already, ...used]
      });

      closePartsModal();
      alert('‚úÖ Repuestos aplicados y stock descontado.');
    } catch(err){
      console.error(err);
      alert('‚ùå Error aplicando repuestos. Revisa consola.');
    }
  };

  // --------------------
  // RENDER (SEGURO)
  // --------------------
  function render(){
    if(!repairsTable || !completedTable) return; // DOM a√∫n no listo
    const s = (searchInput?.value || '').toLowerCase();

    repairsTable.innerHTML = repairs
      .filter(r=>!r.delivered && (!s || (r.clientName||'').toLowerCase().includes(s) || (r.clientPhone||'').includes(s)))
      .map(r=>{
        const partsCount = (r.partsUsed||[]).reduce((acc,x)=>acc + (x.qty||0), 0);

        const badgeClass =
          r.status==='Pendiente' ? 'pending' :
          r.status==='En Proceso' ? 'inprogress' :
          r.status==='Cancelado' ? 'cancelled' :
          'completed';

        const actionButtonsHTML = `
          ${r.status!=='Completado'
            ? `<button onclick="updateStatus('${r.id}','En Proceso')">En Proceso</button>
               <button onclick="updateStatus('${r.id}','Completado')">Completar</button>`
            : ''
          }
          ${!r.delivered ? `<button onclick="markDelivered('${r.id}')">Entregar</button>` : ''}

          ${!r.delivered ? `<button onclick="cancelRepair('${r.id}')" style="background:rgba(239,68,68,.20); color:var(--red); border:1px solid var(--border);">Entregar sin reparar</button>` : ''}

          <button class="small" onclick="openPartsModal('${r.id}')">Usar repuestos ${partsCount?`(${partsCount})`:''}</button>
        `;

        return `
        <tr>
          <td>${r.clientName}</td>
          <td><a href="#" class="whatsapp-link" onclick="openWhatsApp('${r.clientPhone}','${r.clientName}')">${r.clientPhone}</a></td>
          <td>${r.model}</td>
          <td>${r.color||'-'}</td>
          <td>${r.issue}</td>
          <td>${r.price==null?'-':r.price}</td>
          <td>${r.receivedBy||'-'}</td>
          <td>${r.assignedTo||'-'}</td>
          <td><span class="badge ${badgeClass}">${r.status}</span></td>
          <td><button onclick="startEdit('${r.id}')">Editar</button></td>

          <!-- ‚úÖ MODIFICADO: acciones en men√∫ m√≥vil -->
          <td class="actions-cell">
            <!-- PC: botones normales -->
            <div class="actions-wrap">
              ${actionButtonsHTML}
            </div>

            <!-- M√≥vil: men√∫ ‚ãØ -->
            <div class="actions-menu" id="actionsMenu_${r.id}">
              <button type="button" class="actions-trigger" onclick="toggleActionsMenu('${r.id}')">‚ãØ</button>
              <div class="actions-dropdown">
                ${actionButtonsHTML}
              </div>
            </div>
          </td>
        </tr>`;
      }).join('');

    completedTable.innerHTML = repairs
      .filter(r=>r.delivered)
      .map(r=>{
        const partsCount = (r.partsUsed||[]).reduce((acc,x)=>acc + (x.qty||0), 0);

        const isCancelled = (r.status === 'Cancelado');
        const badge = isCancelled
          ? `<span class="badge cancelled">Cancelado</span>`
          : `<span class="badge completed">Completado</span>`;

        return `
        <tr>
          <td>${r.clientName}</td>
          <td><a href="#" class="whatsapp-link" onclick="openWhatsApp('${r.clientPhone}','${r.clientName}')">${r.clientPhone}</a></td>
          <td>${r.model}</td>
          <td>${r.color||'-'}</td>
          <td>${r.issue}</td>
          <td>${r.price==null?'-':r.price}</td>
          <td>${r.receivedBy||'-'}</td>
          <td>${r.assignedTo||'-'}</td>
          <td>${badge}</td>
          <td><button onclick="startEdit('${r.id}')">Editar</button></td>
          <td><button class="small" onclick="openPartsModal('${r.id}')">Repuestos ${partsCount?`(${partsCount})`:''}</button></td>
        </tr>`;
      }).join('');
  }

  // DOM READY
  document.addEventListener('DOMContentLoaded', ()=>{
    // cache DOM
    searchInput = document.getElementById('search');
    repairsTable = document.getElementById('repairsTable');
    completedTable = document.getElementById('completedTable');

    populateStaffSelects();
    if(searchInput) searchInput.oninput = render;

    // buscador en vivo dentro del modal
    const stockSearch = document.getElementById('stockSearch');
    if(stockSearch) stockSearch.addEventListener('input', refreshStockSelect);

    // cerrar modal tocando afuera
    const overlay = document.getElementById('partsModal');
    overlay?.addEventListener('click', (e)=>{
      if(e.target === overlay) closePartsModal();
    });

    /* ‚úÖ NUEVO: cerrar men√∫ de acciones al tocar fuera / scroll */
    document.addEventListener('click', (e)=>{
      // si tocas en el trigger, lo maneja toggleActionsMenu
      if(e.target.closest('.actions-trigger')) return;
      // si tocas dentro del dropdown, no lo cierres aqu√≠
      if(e.target.closest('.actions-dropdown')) return;
      closeAllActionMenus();
    }, true);

    window.addEventListener('scroll', ()=> closeAllActionMenus(), { passive:true });
    window.addEventListener('resize', ()=> closeAllActionMenus(), { passive:true });
    /* ============================ */

    // ahora s√≠ pintar si ya hab√≠an llegado datos
    render();
  });
</script>

</head>
<body>
  <aside>
    <h2>üì± Sistema T√©cnico</h2>
    <nav>
      <a href="index.html">üè† Dashboard</a>
      <a href="inventario.html">üßæ Inventario</a>
      <a href="reparaciones.html" style="background:#0f172a">üîß Reparaciones</a>
    </nav>
  </aside>

  <main>
    <h2>Registrar reparaci√≥n</h2>
    <div class="panel">
      <form id="repairForm" onsubmit="event.preventDefault(); addRepair();">
        <input id="clientName" placeholder="Nombre del cliente">
        <input id="clientPhone" placeholder="Tel√©fono del cliente">
        <input id="deviceModel" placeholder="Modelo del dispositivo">
        <input id="deviceColor" placeholder="Color (opcional)">
        <input id="issue" placeholder="Problema / Reparaci√≥n">
        <input id="price" placeholder="Precio">
        <select id="receivedBy"><option value="">-- Recibi√≥ --</option></select>
        <select id="assignedTo"><option value="">-- Asignado a --</option></select>
        <button id="submitRepair" type="submit">Agregar reparaci√≥n</button>
        <button id="cancelEdit" type="button" onclick="cancelEdit()" style="display:none; margin-left:8px; background:transparent; border:1px solid var(--border);">Cancelar</button>
      </form>
    </div>

    <div class="panel">
      <h3>Reparaciones activas</h3>
      <input id="search" placeholder="Buscar cliente o tel√©fono">
      <table>
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Tel√©fono</th>
            <th>Modelo</th>
            <th>Color</th>
            <th>Problema</th>
            <th>Precio</th>
            <th>Recibi√≥</th>
            <th>Asignado</th>
            <th>Estado</th>
            <th>Editar</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="repairsTable"></tbody>
      </table>
    </div>

    <div class="panel">
      <details>
        <summary>üì¶ Ver historial de reparaciones completadas</summary>
        <table class="details-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Tel√©fono</th>
              <th>Modelo</th>
              <th>Color</th>
              <th>Problema</th>
              <th>Precio</th>
              <th>Recibi√≥</th>
              <th>Asignado</th>
              <th>Estado</th>
              <th>Editar</th>
              <th>Repuestos</th>
            </tr>
          </thead>
          <tbody id="completedTable"></tbody>
        </table>
      </details>
    </div>
  </main>

  <!-- ‚úÖ Modal Repuestos -->
  <div class="modal-overlay" id="partsModal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="partsTitle">Usar repuestos</h3>
      <div class="muted">
        Busca por modelo/tipo/desc, agrega items con cantidad y confirma.
        Se registrar√° como salida y se guardar√° en la reparaci√≥n.
      </div>

      <div class="modal-grid">
        <div>
          <label>Buscar repuesto</label>
          <input id="stockSearch" placeholder="Ej: iPhone 11, bater√≠a, OLED...">
        </div>

        <div style="grid-column: 2 / span 2;">
          <label>Item del inventario</label>
          <select id="stockSelect"></select>
        </div>

        <div>
          <label>Cantidad</label>
          <input id="partQty" type="number" min="1" placeholder="Ej: 1">
        </div>

        <div>
          <button type="button" onclick="addPartLine()">Agregar</button>
        </div>
      </div>

      <div style="margin-top:12px">
        <label style="font-size:13px; color:var(--muted); display:block; margin-bottom:6px">Autoriz√≥</label>
        <select id="authSelect"></select>
      </div>

      <div id="selectedParts" style="margin-top:10px"></div>

      <div class="modal-actions">
        <button class="btn-ghost" type="button" onclick="closePartsModal()">Cancelar</button>
        <button type="button" onclick="confirmPartsUse()">Confirmar salida</button>
      </div>
    </div>
  </div>

</body>
</html>
