<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Inventario Pantallas y Bater√≠as - Firebase</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --panel-soft:#111827;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --primary:#38bdf8;
  --primary-hover:#0ea5e9;
  --green:#22c55e;
  --yellow:#facc15;
  --red:#ef4444;
}
*{ box-sizing:border-box }
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
}

header{ padding:20px; border-bottom:1px solid var(--border); }
main{ padding:24px; max-width:1400px; margin:auto; }
 /* Sidebar */
      aside {
        width: 240px;
        background: #020617;
        border-right: 1px solid var(--border);
        padding: 20px;
      }

      aside h2 {
        font-size: 18px;
        margin-bottom: 30px;
      }

      nav a {
        display: block;
        padding: 12px 14px;
        margin-bottom: 10px;
        border-radius: 10px;
        color: var(--text);
        text-decoration: none;
        background: transparent;
      }
.panel{ background:linear-gradient(180deg,var(--panel),var(--panel-soft)); border:1px solid var(--border); border-radius:14px; padding:20px; margin-bottom:20px; }
input,select,button{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#020617; color:var(--text); }
button{ background:var(--primary); color:#020617; font-weight:600; cursor:pointer; }
button:hover{ background:var(--primary-hover) }
table{ width:100%; border-collapse:collapse; margin-top:12px; }
th,td{ padding:12px; border-bottom:1px solid var(--border); }
.table-responsive{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
.table-responsive table{ width:100%; min-width:0; }
.table-responsive th,.table-responsive td{ word-break:break-word; white-space:normal; }
.pager{ display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap }
.pager button{ padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer }
.pager button[disabled]{ opacity:.4; cursor:default }
.badge{ padding:4px 10px; border-radius:999px; font-size:12px; font-weight:600; }
.pantalla{ background:rgba(34,197,94,.15); color:var(--green) }
.bateria{ background:rgba(250,204,21,.2); color:var(--yellow) }
.actions button{ margin-right:6px }
.in{ background:rgba(34,197,94,.25); color:var(--green) }
.out{ background:rgba(239,68,68,.25); color:var(--red) }
.del{ background:rgba(148,163,184,.2) }
details{ margin-top:12px; }
  /* Responsive tweaks (copiado de reparaciones.html) */
      @media (max-width: 800px) {
        body { flex-direction: column; }
        aside { width: 100%; border-right: none; border-bottom: 1px solid var(--border); }
        main { padding: 14px; }
        nav a { display: inline-block; margin-right: 8px; }
        .panel { padding: 12px; }
        input, select, button { width: 100%; margin-top: 8px; }
        .panel { overflow-x: auto; }
        table { min-width: 0; table-layout:fixed; }
        th,td{ padding:8px; }
        .details-table th, .details-table td { font-size: 13px; }
      }

</style>

<!-- üîπ Firebase modular v10 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, update, remove } 
    from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

  // Configuraci√≥n de Firebase
  const firebaseConfig = {
     apiKey: "AIzaSyAiQ-NtIyWp_CaAj8jjyuDLskzVOoV_H6g",
  authDomain: "control-de-inventario-633f5.firebaseapp.com",
  databaseURL: "https://control-de-inventario-633f5-default-rtdb.firebaseio.com",
  projectId: "control-de-inventario-633f5",
  storageBucket: "control-de-inventario-633f5.firebasestorage.app",
  messagingSenderId: "1012694355492",
  appId: "1:1012694355492:web:08a9ebccbff0c6620ed2b1"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Variables globales
  let stock = [];
  let logs = [];
  let costs = [];
  let models = [
    'iPhone 8','iPhone 8 Plus','iPhone X','iPhone XR','iPhone XS','iPhone XS Max',
    'iPhone 11','iPhone 11 Pro','iPhone 11 Pro Max',
    'iPhone 12','iPhone 12 Pro','iPhone 12 Pro Max',
    'iPhone 13','iPhone 13 Pro','iPhone 13 Pro Max',
    'iPhone 14','iPhone 14 Pro','iPhone 14 Pro Max',
    'iPhone 15','iPhone 15 Pro','iPhone 15 Pro Max',
    'iPhone 16','iPhone 16 Pro','iPhone 16 Pro Max',
    'iPhone 17','iPhone 17 Pro','iPhone 17 Pro Max',
    'Samsung S21 Ultra','Samsung S22 Ultra','Samsung S23 Ultra','Samsung S24 Ultra','Samsung S25 Ultra'
  ];
  // Elementos DOM
  const modelInput = document.getElementById('model');
  const descInput = document.getElementById('desc');
  const typeSelect = document.getElementById('type');
  const addBtn = document.getElementById('addModel');
  const table = document.getElementById('table');
  const search = document.getElementById('search');
  const logsT = document.getElementById('logs');
  const costsT = document.getElementById('costs');
  const modelsList = document.getElementById('models');

  function refreshModels(){
    modelsList.innerHTML = models.map(m=>`<option value="${m}">`).join('');
  }
  refreshModels();

  // Escuchar stock
onValue(ref(db,'stock'), snapshot=>{
  stock = [];
  snapshot.forEach(child=>{
    stock.push({id: child.key, ...child.val()});
  });
  console.log("Stock actualizado:", stock);
  renderAll();
});

// Escuchar logs
onValue(ref(db,'logs'), snapshot=>{
  logs = [];
  snapshot.forEach(child=>{
    logs.push({id: child.key, ...child.val()});
  });
  console.log("Logs actualizados:", logs);
  renderAll();
});

// Escuchar costs
onValue(ref(db,'costs'), snapshot=>{
  costs = [];
  snapshot.forEach(child=>{
    costs.push({id: child.key, ...child.val()});
  });
  console.log("Costs actualizados:", costs);
  renderAll();
});

// Bot√≥n agregar modelo
addBtn.onclick = ()=>{
  const model = modelInput.value.trim();
  const desc = descInput.value.trim();
  const type = typeSelect.value;
  if(!model) return;

  if(!models.includes(model)){
    models.push(model);
    refreshModels();
  }

  // üîπ Guardar en Firebase
  const newItemRef = push(ref(db,'stock'));
  set(newItemRef, { model, type, desc, qty: 0 })
    .then(()=>{
      console.log("Agregado:", model, type, desc);
    })
    .catch(err=>console.error("Error al guardar:", err));

  modelInput.value = '';
  descInput.value = '';
};


  window.move = (id, dir)=>{
    const qty = parseInt(prompt('Cantidad'));
    if(!qty || qty <= 0) return;

    const item = stock.find(i=>i.id===id);
    if(dir==='out' && item.qty<qty){
      alert('Stock insuficiente');
      return;
    }

    if(dir==='in'){
      const price = parseFloat(prompt('Precio unitario de compra'));
      if(!price || price <=0) return;
      const newCost = { date: new Date().toLocaleString(), model:item.model, qty, price, total: qty*price };
      set(push(ref(db,'costs')), newCost);
    }

    set(push(ref(db,'logs')), {
      date: new Date().toLocaleString(),
      model: item.model,
      action: dir==='in'?'Entrada':'Salida',
      qty
    });

    update(ref(db,'stock/'+id), { qty: dir==='in'?item.qty+qty:item.qty-qty });
  }

  window.removeItem = (id)=>{
    const item = stock.find(i=>i.id===id);
    if(!item) return;
    if(!confirm(`Eliminar ${item.model} (${item.desc})?`)) return;
    remove(ref(db,'stock/'+id));
  }

  const PAGE_SIZE = 6;
  let invPage = 1, logsPage = 1, costsPage = 1;

  function paginate(arr, page){
    const total = Math.max(1, Math.ceil(arr.length / PAGE_SIZE));
    const start = (page - 1) * PAGE_SIZE;
    return { items: arr.slice(start, start + PAGE_SIZE), total };
  }

  function renderPager(pagerId, type, total, current){
    const el = document.getElementById(pagerId);
    if(!el) return;
    el.innerHTML = '';
    const prev = document.createElement('button'); prev.textContent = 'Anterior';
    prev.disabled = current <= 1; prev.onclick = ()=> setPage(type, current - 1);
    const info = document.createElement('div'); info.textContent = `P√°gina ${current} de ${total}`;
    const next = document.createElement('button'); next.textContent = 'Siguiente';
    next.disabled = current >= total; next.onclick = ()=> setPage(type, current + 1);
    el.appendChild(prev);
    el.appendChild(info);
    el.appendChild(next);
  }

  window.setPage = (type, page)=>{
    if(type==='inv'){ invPage = Math.min(Math.max(1,page),100000); renderInventory(); }
    if(type==='logs'){ logsPage = Math.min(Math.max(1,page),100000); renderLogs(); }
    if(type==='costs'){ costsPage = Math.min(Math.max(1,page),100000); renderCosts(); }
  }

  function renderInventory(){
    const s = (search.value||'').toLowerCase();
    const filtered = stock.filter(i=>!s || (i.model||'').toLowerCase().includes(s));
    const { items, total } = paginate(filtered, invPage);
    table.innerHTML = items.map(i=>`
      <tr>
        <td>${i.model}</td>
        <td><span class="badge ${i.type}">${i.type}</span></td>
        <td>${i.desc||'-'}</td>
        <td>${i.qty}</td>
        <td class="actions">
          <button class="in" onclick="move('${i.id}','in')">‚ûï</button>
          <button class="out" onclick="move('${i.id}','out')">‚ûñ</button>
          <button class="del" onclick="removeItem('${i.id}')">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
    renderPager('inventoryPager','inv', total, invPage);
  }

  function renderLogs(){
    const { items, total } = paginate(logs, logsPage);
    logsT.innerHTML = items.map(l=>`
      <tr>
        <td>${l.date}</td>
        <td>${l.model}</td>
        <td>${l.action}</td>
        <td>${l.qty}</td>
      </tr>`).join('');
    renderPager('logsPager','logs', total, logsPage);
  }

  function renderCosts(){
    const { items, total } = paginate(costs, costsPage);
    costsT.innerHTML = items.map(c=>`
      <tr>
        <td>${c.date}</td>
        <td>${c.model}</td>
        <td>${c.qty}</td>
        <td>${c.price}</td>
        <td>${c.total}</td>
      </tr>`).join('');
    renderPager('costsPager','costs', total, costsPage);
  }

  function renderAll(){ renderInventory(); renderLogs(); renderCosts(); }

  search.oninput = ()=>{ invPage = 1; renderInventory(); };
</script>
  </head>
<body>


  <!-- SIDEBAR -->
  <aside>
    <h2>üì± Sistema T√©cnico</h2>
    <nav>
      <a href="index.html">üè† Dashboard</a>
      <a href="inventario.html" style="background:#0f172a">üßæ Inventario</a>
      <a href="reparaciones.html">üîß Reparaciones</a>
    </nav>
  </aside>

  <!-- CONTENIDO -->
  <main>

    <header>
      <h2>Inventario de Pantallas y Bater√≠as</h2>
      <div style="color:var(--muted)">
        Con descripci√≥n y control interno de costos en la nube
      </div>
    </header>

    <!-- Panel para agregar modelos -->
    <div class="panel">
      <h3>Agregar modelo</h3>
      <select id="type">
        <option value="pantalla">Pantalla</option>
        <option value="bateria">Bater√≠a</option>
      </select>
      <input id="model" list="models" placeholder="Modelo (ej: iPhone 11)">
      <input id="desc" placeholder="Descripci√≥n (ej: Con marco / OLED)">
      <datalist id="models"></datalist>
      <button id="addModel">Agregar</button>
    </div>

    <!-- Panel de inventario -->
    <div class="panel">
      <h3>Inventario</h3>
      <input id="search" placeholder="Buscar modelo">
      <div class="table-responsive">
        <table>
        <thead>
          <tr>
            <th>Modelo</th>
            <th>Tipo</th>
            <th>Descripci√≥n</th>
            <th>Cantidad</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="table"></tbody>
      </table>
        </div>
        <div class="pager" id="inventoryPager"></div>
    </div>

    <!-- Panel de historial -->
    <div class="panel">
      <h3>Historial de movimientos</h3>
      <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Modelo</th>
            <th>Acci√≥n</th>
            <th>Cantidad</th>
          </tr>
        </thead>
        <tbody id="logs"></tbody>
      </table>
      </div>
      <div class="pager" id="logsPager"></div>

      <details>
        <summary>üìä Ver historial de costos (interno)</summary>
        <div class="table-responsive">
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Modelo</th>
              <th>Cantidad</th>
              <th>Precio unitario</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="costs"></tbody>
        </table>
        </div>
        <div class="pager" id="costsPager"></div>
      </details>
    </div>

  </main>
</body>

</html>